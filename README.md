# Amcham Admin Panel Repository Documentation

This is the repository documentation for the Amcham Admin Panel backend server, with the following node configuration:

## Description

This is the backend server for the Amcham Admin Panel. It is designed to manage and handle various tasks and functions of the admin panel.

## Scripts

The following scripts are available in this repository:

- `tsc`: runs the TypeScript compiler
- `start`: compiles TypeScript and starts the server
- `dev`: runs the server in development mode
- `format`: formats the code using Prettier
- `fill_db`: compiles and runs the script to fill the database with data

## Dependencies

This repository has the following dependencies:

- `bcrypt`: used to hash passwords
- `cors`: allows cross-origin resource sharing
- `dotenv`: loads environment variables from a .env file
- `express`: a web application framework
- `express-validator`: validates data in HTTP requests
- `jsonwebtoken`: generates and verifies JSON web tokens
- `morgan`: logs HTTP requests
- `nodemailer`: sends emails
- `pg`: a PostgreSQL client
- `pg-hstore`: serializes and deserializes JSON data for PostgreSQL
- `sequelize`: an ORM for Node.js

## Dev Dependencies

This repository has the following dev dependencies:

- `@types/bcrypt`: TypeScript type definitions for bcrypt
- `@types/cors`: TypeScript type definitions for cors
- `@types/express`: TypeScript type definitions for express
- `@types/jsonwebtoken`: TypeScript type definitions for jsonwebtoken
- `@types/morgan`: TypeScript type definitions for morgan
- `@types/node`: TypeScript type definitions for Node.js
- `@types/nodemailer`: TypeScript type definitions for nodemailer
- `@types/sequelize`: TypeScript type definitions for sequelize
- `nodemon`: automatically restarts the server when files change
- `prettier`: code formatter
- `ts-node-dev`: runs TypeScript files in development mode
- `typescript`: a superset of JavaScript that adds optional static typing

# API Documentation

The base URL for Admin Panel API endpoints is `https://amcham-server-admin.up.railway.app/`.

## Authentication

Authentication is done via a Bearer Token, which is generated by the login endpoint, this application doesn’t have a register form.

## HTTP Verbs

The API supports the following HTTP verbs:

- `GET` – Used to retrieve data from the server.
- `POST` – Used to create a new resource on the server.
- `PUT` – Used to update an existing resource on the server.
- `DELETE` – Used to delete a resource from the server.

## Response Formats

The API supports the following response formats:

- `JSON` – Used for data serialization. Generally using this format:

```jsx
if (something) {
      return response.status(400).json({
        ok: false,
        msg: "Message",
      });
    }
```

## Panel Admin API

The Admin API is for user management, and for CRUD for ranges.

### Auth Endpoints

### `POST /auth/login`

Allow to log in, giving back the generate toke if the email and password are correct.

```jsx
POST /auth/login
{
    "email":"eitecknologia@gmail.com",
    "password":"123456"
}
```

### `POST /auth/create`

Creates a new user, only allow for Super administrator, need log in.

```jsx
POST /auth/create
{
    "name":"Christian",
    "last_name":"Guaman",
    "email":"guamanc9@gmail.com",
    "password":"windows8"
}
```

### `PUT /auth/update_password`

Update password when a user is logged.

```jsx
PUT /auth/update_password
{
    "currentPassword":"windows7",
    "password":"123456"
}
```

### `POST /auth/send_email_password`

Send email to recover the password, the email message contains this string `${process.env.RESET_PASSWORD_URL}?user_id=${user_id}&token=${token}`.

```jsx
POST /auth/send_email_password
{
    "email":"eitecknologia@gmail.com"
}
```

### `POST /auth/set_new_password`

Set the new password using the URL provided in the email message.

```jsx
POST /auth/set_new_password
{
    "user_id":7,
    "token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NywiaWF0IjoxNjgyNjEzOTU4LCJleHAiOjE2ODI3MDAzNTh9.8gv4IbIeKdR1h__jvTPPGMjbYSu-w4fpa6tsyjQnKhQ",
    "password":"windows7"
}
```

### User Endpoints

### `GET /user/get_all`

Retrieves all users stored on the DB, need to log in.

```jsx
GET /user/get_all
Response
{
    "ok": true,
    "msg": "Lista de usuarios",
    "users": [
        {
            "user_id": 14,
            "name": "Martin",
            "last_name": "Campoverde Solórzano",
            "email": "alejandro.campoverde@ucuenca.edu.ec",
            "is_admin": false,
            "is_active": true,
            "createdAt": "2023-04-28T20:30:54.955Z"
        },
        {
            "user_id": 13,
            "name": "Martin",
            "last_name": "Campoverde",
            "email": "chanmaster0@gmail.com",
            "is_admin": false,
            "is_active": true,
            "createdAt": "2023-04-26T23:46:23.525Z"
        },
        {
            "user_id": 7,
            "name": "Alejandro",
            "last_name": "Administrator",
            "email": "eitecknologia@gmail.com",
            "is_admin": true,
            "is_active": true,
            "createdAt": "2023-04-25T22:07:24.874Z"
        }
    ]
}
```

### `GET /user/get_my_info`

Retrieves user info, restricted to the logged user.

```jsx
GET /user/get_my_info

Response
{
    "ok": true,
    "msg": "Información del usuario",
    "user": {
        "user_id": 7,
        "name": "Alejandro",
        "last_name": "Administrator",
        "email": "eitecknologia@gmail.com",
        "is_admin": true,
        "is_active": true,
        "createdAt": "2023-04-25T22:07:24.874Z"
    }
}
```

### `PUT /user/update`

Update user, all fields are optional except user_id, is_active can be change only by Super Administrator.

```jsx
PUT /user/update
{
    "user_id":7,
    "name":"Geovanny",
		"last_name":"Guaman",
		"email":"asdasd@gmail.com",
    "is_active":true
}
```

### `DELETE /user/delete`

Update user, all fields are optional except user_id, is_active can be change only by Super Administrator. Pass ID using params.

```jsx
DELETE /user/delete/1
```

### Ranges Endpoints

### `GET /ranges/get_all_ranges?range_type=ARBITRATION_ONE`

Retrieves all ranges base on query params, possible range types: `MEDIATION`, `ARBITRATION_ONE`, and `ARBITRATION_THREE`.

```jsx
GET /ranges/get_all_ranges?range_type=ARBITRATION_ONE

Response
{
    "ok": true,
    "msg": "Lista de rangos tipo ARBITRATION_ONE",
    "ranges": [
        {
            "range_id": 13,
            "range_type": "ARBITRATION_ONE",
            "from_range": 0,
            "to_range": 31999.99,
            "base": 1100,
            "excess_percentage": 3.75,
            "can_delete": false,
            "createdAt": "2023-05-03T18:58:34.302Z",
            "updatedAt": "2023-05-03T18:58:34.302Z"
        },
        {
            "range_id": 14,
            "range_type": "ARBITRATION_ONE",
            "from_range": 32000,
            "to_range": 63999.99,
            "base": 2300,
            "excess_percentage": 3.5,
            "can_delete": false,
            "createdAt": "2023-05-03T18:58:34.302Z",
            "updatedAt": "2023-05-03T18:58:34.302Z"
        },
    ]
}
```

### `POST /ranges/create_range`

Creates a range always at the bottom of the table of each calculation type, because it only can delete the last one.

```jsx
POST /ranges/create_range
{
    "range_type": "MEDIATION",
    "from_range": 0,
    "to_range": 18900.00,
    "base": 120.21,
    "excess_percentage": 1.75
}
```

### `PUT /update_range/:range_id`

Update the range using the range ID.

```jsx
PUT /update_range/:range_id
{
    "from_range": 32001.00,
    "to_range":400000.00,
    "base": 12.12,
    "excess_percentage":23.23
}
```

### `DELETE /delete/:range_id`

Delete the range using the range ID, only the last range can be deleted.

```jsx
DELETE /update_range/:range_id
{
    "from_range": 32001.00,
    "to_range":400000.00,
    "base": 12.12,
    "excess_percentage":23.23
}
```

### Ranges Endpoints

### `POST /calcs/get_all_history_calcs`

Retrieves all the calculation made by the users by calculation type: MEDIATION, ARBITATRION_ONE, and ABITRATION_THREE. This endpoint support pagination of 15 items.

```jsx
POST /calcs/get_all_history_calcs

Request
{
    "calculation_type":"MEDIATION"
}

```

**Response**

```jsx
{
    "ok": true,
    "msg": "Historial de cálculos obtenido correctamente",
    "info": {
        "total": 2,
        "totalPages": 1,
        "currentPage": 1,
        "hasPrevPage": false,
        "prevPage": null,
        "hasNextPage": false,
        "nextPage": null,
        "limit": 15
    },
    "calcs": [
        {
            "history_calcs_id": 152,
            "name": "John Doe",
            "email": "",
            "company_name": "ACME",
            "phone_number": "555-1234",
            "calculation_type": "MEDIATION",
            "consulted_amount": 54970.45,
            "result": 862.81,
            "date": "2023-05-05T21:42:45.949Z"
        },
        {
            "history_calcs_id": 151,
            "name": "Christian Guaman",
            "email": "",
            "company_name": "EiteckQQQ",
            "phone_number": "09524342323",
            "calculation_type": "MEDIATION",
            "consulted_amount": 8900,
            "result": 210.63,
            "date": "2023-05-05T21:42:45.482Z"
        }
    ]
}
```